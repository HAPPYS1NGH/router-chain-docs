"use strict";(self.webpackChunkrouter_docs=self.webpackChunkrouter_docs||[]).push([[2938],{3905:(e,t,n)=>{n.d(t,{Zo:()=>c,kt:()=>p});var r=n(67294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function s(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function o(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},i=Object.keys(e);for(r=0;r<i.length;r++)n=i[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(r=0;r<i.length;r++)n=i[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var l=r.createContext({}),d=function(e){var t=r.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):s(s({},t),e)),n},c=function(e){var t=d(e.components);return r.createElement(l.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},m=r.forwardRef((function(e,t){var n=e.components,a=e.mdxType,i=e.originalType,l=e.parentName,c=o(e,["components","mdxType","originalType","parentName"]),m=d(n),p=a,y=m["".concat(l,".").concat(p)]||m[p]||u[p]||i;return n?r.createElement(y,s(s({ref:t},c),{},{components:n})):r.createElement(y,s({ref:t},c))}));function p(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var i=n.length,s=new Array(i);s[0]=m;var o={};for(var l in t)hasOwnProperty.call(t,l)&&(o[l]=t[l]);o.originalType=e,o.mdxType="string"==typeof e?e:a,s[1]=o;for(var d=2;d<i;d++)s[d]=n[d];return r.createElement.apply(null,s)}return r.createElement.apply(null,n)}m.displayName="MDXCreateElement"},36149:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>s,default:()=>u,frontMatter:()=>i,metadata:()=>o,toc:()=>d});var r=n(87462),a=(n(67294),n(3905));const i={title:"Sample Delayed Execution ASM Contract",sidebar_position:3},s=void 0,o={unversionedId:"message-transfer-via-crosstalk/evm-guides/asm-implementation/sample-delayed-execution-asm-contract",id:"message-transfer-via-crosstalk/evm-guides/asm-implementation/sample-delayed-execution-asm-contract",title:"Sample Delayed Execution ASM Contract",description:"A delayed execution ASM deliberately delays a cross-chain request by a certain period to force the validation of the request only once a certain amount of time has lapsed. After the request is delayed, the owner has the flexibility to reject the transaction if there is something malicious or invalid with the transaction.",source:"@site/docs/develop/message-transfer-via-crosstalk/evm-guides/asm-implementation/sample-delayed-execution-asm-contract.md",sourceDirName:"message-transfer-via-crosstalk/evm-guides/asm-implementation",slug:"/message-transfer-via-crosstalk/evm-guides/asm-implementation/sample-delayed-execution-asm-contract",permalink:"/develop/message-transfer-via-crosstalk/evm-guides/asm-implementation/sample-delayed-execution-asm-contract",draft:!1,editUrl:"https://github.com/router-protocol/docs/tree/main/docs/develop/message-transfer-via-crosstalk/evm-guides/asm-implementation/sample-delayed-execution-asm-contract.md",tags:[],version:"current",sidebarPosition:3,frontMatter:{title:"Sample Delayed Execution ASM Contract",sidebar_position:3},sidebar:"tutorialSidebar",previous:{title:"Integrate ASM into Your Application",permalink:"/develop/message-transfer-via-crosstalk/evm-guides/asm-implementation/integrate-asm-into-your-application"},next:{title:"Near Guides",permalink:"/develop/message-transfer-via-crosstalk/near-guides/"}},l={},d=[],c={toc:d};function u(e){let{components:t,...n}=e;return(0,a.kt)("wrapper",(0,r.Z)({},c,n,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("p",null,"A delayed execution ASM deliberately delays a cross-chain request by a certain period to force the validation of the request only once a certain amount of time has lapsed. After the request is delayed, the owner has the flexibility to reject the transaction if there is something malicious or invalid with the transaction."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-javascript"},'// Delay ASM\ncontract DelayASM is IAdditionalSecurityModule {\n    mapping(bytes32 => bool) public delayedTransfers;\n    address public immutable gatewayContract;\n    uint256 public delayPeriod;\n    address public immutable owner;\n    string public appRouterBridgeAddress;\n\n    constructor(address gatewayAddress, uint256 _delayPeriod, string memory _routerBridgeAddress) {\n        gatewayContract = gatewayAddress;\n        owner = msg.sender;\n        delayPeriod = _delayPeriod;\n        appRouterBridgeAddress = _routerBridgeAddress;\n    }\n\n    function setDelayPeriod(uint256 _delayPeriod) external {\n        require(msg.sender == owner, "Caller is not owner");\n        delayPeriod = _delayPeriod;\n    }\n\n    function rejectRequest(bytes32 id) external {\n        require(msg.sender == owner);\n        delayedTransfers[id] = true;\n    }\n\n    function verifyCrossChainRequest(\n        uint256 requestIdentifier,\n        uint256 requestTimestamp,\n        string calldata requestSender,\n        string calldata srcChainId,\n        bytes calldata payload,\n        address handler\n    ) external view returns (bool) {\n        require(msg.sender == gatewayContract, "Caller is not gateway");\n        bytes32 id = keccak256(\n            abi.encode(requestIdentifier, requestTimestamp, requestSender, srcChainId, payload, handler)\n        );\n        if (delayedTransfers[id]) {\n            return false;\n        }\n        if (block.timestamp > requestTimestamp + delayPeriod) {\n            return true;\n        }\n        revert("Transaction needs to be delayed");\n    }\n}\n')),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"The owner of the ASM contract can set the\xa0",(0,a.kt)("inlineCode",{parentName:"li"},"delayPeriod"),", which is the period that must pass before transactions can be executed on the destination contract once they have been validated on the Router chain.")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-javascript"},'  function setDelayPeriod(uint256 _delayPeriod) external {\n      require(msg.sender == owner, "Caller is not owner");\n      delayPeriod = _delayPeriod;\n  }\n')),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("p",{parentName:"li"},"The Gateway contract invokes the\xa0",(0,a.kt)("inlineCode",{parentName:"p"},"verifyCrossChainRequest"),"\xa0function before invoking the destination contract. It checks whether the transaction (a) has been rejected by the owner of the ASM contract, (b) is delayed or, (c) has reached the delay period."),(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",{parentName:"pre",className:"language-javascript"},'function verifyCrossChainRequest(\n  uint256 requestIdentifier,\n  uint256 requestTimestamp,\n  string memory requestSender,\n  string memory srcChainId,\n  bytes memory packet,\n  address handler\n) external view returns (bool) {\n  require(msg.sender == gatewayContract, "Caller is not gateway");\n      bytes32 id = keccak256(\n          abi.encode(requestIdentifier, requestTimestamp, requestSender, srcChainId, payload, handler)\n      );\n      if (delayedTransfers[id]) {\n          return false;\n      }\n      if (block.timestamp > requestTimestamp + delayPeriod) {\n          return true;\n      }\n      revert("Transaction needs to be delayed");\n}\n'))),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("p",{parentName:"li"},"The owner of the contract can reject a transaction by its ",(0,a.kt)("inlineCode",{parentName:"p"},"ID"),", which is the ABI-encoded function arguments in order."),(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",{parentName:"pre",className:"language-javascript"},"function rejectRequest(bytes32 id) external {\n      require(msg.sender == owner);\n      delayedTransfers[id] = true;\n  }\n")))))}u.isMDXComponent=!0}}]);